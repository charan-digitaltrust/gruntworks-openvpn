#!/bin/bash

#
# Install the latest OpenVPN Server on Ubuntu 16 from the OpenVPN apt repositories.
#

# Immediately exit if any command fails
set -e

readonly CA_PATH="/etc/openvpn-ca"
readonly OPENVPN_PATH="/etc/openvpn"

# Verify we're running as root or sudo
function assert_uid_is_root_or_sudo {
    if [[ $EUID != 0 ]]; then
        echo "ERROR: This script should be run using sudo or as the root user"
        exit 1
    fi
}

# Import the public GPG key used to sign the OpenVPN packages.
function import_gpg_key {
    wget -O - https://swupdate.openvpn.net/repos/repo-public.gpg | sudo apt-key add -
}

# Create a sources.list fragment (as root) so that apt can find the new OpenVPN packages.
function create_apt_sources_list_fragment {
    local readonly apt_repo_url="$1"
    local readonly ubuntu_distro_name="$2"

    echo "deb $apt_repo_url $ubuntu_distro_name main" >/etc/apt/sources.list.d/swupdate.openvpn.net.list
}

# Use apt to install the latest OpenVPN
function install_openvpn_package {
    echo "Installing OpenVPN package..."
    apt-get update
    apt-get -y install openssl easy-rsa openvpn
    echo "Making CA directory in $CA_PATH..."
    make-cadir $CA_PATH
}

function copy_wrapper_scripts {
    echo "Installing Wrapper Scripts..."
    cp /gruntwork/install-openvpn/generate-wrapper.sh $CA_PATH
    cp /gruntwork/install-openvpn/revoke-wrapper.sh $CA_PATH
    chmod +x $CA_PATH/generate-wrapper.sh
    chmod +x $CA_PATH/revoke-wrapper.sh
}

function install_aws_cli {
    echo "Install AWS CLI..."
    apt-get -y install python-pip jq
    pip install --upgrade pip
    pip install awscli
}

# Upgrade OpenSSL to the latest version
function upgrade_openssl {
    echo "Upgrading OpenSSL..."
    DEBIAN_FRONTEND=noninteractive apt-get upgrade -y openssl
}

# Our main function
function install_openvpn {
    assert_uid_is_root_or_sudo

    local readonly ubuntu_distro_name="xenial" # xenial = ubuntu16
    local readonly apt_repo_url="http://swupdate.openvpn.net/apt"
    local readonly gpg_key_url="https://swupdate.openvpn.net/repos/repo-public.gpg"

    import_gpg_key "$gpg_key_url"
    create_apt_sources_list_fragment "$apt_repo_url" "$ubuntu_distro_name"
    install_openvpn_package
    copy_wrapper_scripts
    upgrade_openssl
    install_aws_cli
}

install_openvpn
